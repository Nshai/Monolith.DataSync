<?xml version="1.0" encoding="utf-8" ?>
<hibernate-mapping xmlns="urn:nhibernate-mapping-2.2"
                   assembly="Microservice.Workflow"
                   namespace="Microservice.Workflow.Domain"
                   default-lazy="true"
									 default-access="field.camelcase"
                   schema="workflow.dbo">

  <class name="Template" table="TTemplate" >
    <id name="Id" column="TemplateId">
      <generator class="identity"/>
    </id>

    <property name="Name" />
    <property name="CreatedDate" type="UtcDateTime"/>
    <property name="RelatedTo" type="Microservice.Workflow.GenericEnumMapper`1[[Microservice.Workflow.Domain.WorkflowRelatedTo, Microservice.Workflow]], Microservice.Workflow" />
    <property name="TenantId" access="field.camelcase"/>
    <property name="ConcurrencyId"/>
    <!-- This is a workaround because we can't query Status property on TemplateVersion via OData -->
    <property name="Status" formula="(select top 1 t.Status from workflow.dbo.TTemplateVersion t where t.TemplateId = TemplateId)"/>
    
    <many-to-one name="Category"
                class="TemplateCategory"
                column="TemplateCategoryId"
                cascade="none"
                fetch="join"/>
    
    <bag name="Versions" inverse="true"
          cascade="all-delete-orphan"
          lazy="false" fetch="join">
      <key column="TemplateId" />
      <one-to-many class="TemplateVersion" />
    </bag>

  </class>
</hibernate-mapping>