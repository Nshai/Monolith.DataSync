<?xml version="1.0" encoding="utf-8" ?>
<hibernate-mapping xmlns="urn:nhibernate-mapping-2.2"
                   assembly="Microservice.Workflow"
                   namespace="Microservice.Workflow.Domain"
                   default-lazy="true"
									 default-access="property"
                   schema="workflow.dbo">

  <class name="TemplateVersion" table="TTemplateVersion" >
    <id name="Id" column="TemplateVersionId">
      <generator class="identity"/>
    </id>
    
    <property name="Guid" />
    <property name="IncludeSubGroups" />
    <property name="Notes" />
    <property name="CreatedDate" type="UtcDateTime" />
    <property name="Status" type="Microservice.Workflow.GenericEnumMapper`1[[Microservice.Workflow.Domain.WorkflowStatus, Microservice.Workflow]], Microservice.Workflow"/>
    <property name="OwnerUserId"/>
    <property name="TenantId"/>
    <property name="ApplicableToGroupId"/>
    <property name="ConcurrencyId"/>
    <property name="InUse" formula="(select top(1) 1 from workflow.dbo.WF_TInstance i where i.TemplateId = Guid)" />

    <property name="Definition"
              type="IntelliFlo.Platform.NHibernate.Types.DocumentUserType`1[[Microservice.Workflow.Domain.WorkflowDefinition, Microservice.Workflow]], IntelliFlo.Platform.NHibernate"
              not-null="true" />

    <many-to-one name="Template"
                     class="Template"
                     column="TemplateId"
                     fetch="select"/>

    <bag name="Roles" cascade="all-delete-orphan" lazy="true" inverse="true" access="field.camelcase" >
      <key column="TemplateVersionId"/>
      <one-to-many class="TemplateRole" />
    </bag>

    <bag name="Triggers" cascade="all-delete-orphan" lazy="true" inverse="true" access="field.camelcase" >
      <key column="TemplateVersionId"/>
      <one-to-many class="TemplateTriggerSet" />
    </bag>

  </class>

</hibernate-mapping>

